# https://docs.github.com/en/actions/creating-actions/creating-a-composite-action
name: "Test custom"
description: "Custom test step to run during a pull request"
# this inputs are always provided by flowzone, so they must always be defined on the composite action
inputs:
  json:
    description: "JSON stringified object containing all the inputs from the calling workflow"
    required: true
  secrets:
    description: "JSON stringified object containing all the secrets from the calling workflow"
    required: true
  variables:
    description: "JSON stringified object containing all the variables from the calling workflow"
    required: true
runs:
  using: "composite"
  steps:
    - name: Install systemd development packages and valgrind
      shell: bash
      run: |
        sudo apt update
        sudo apt install -y libsystemd0 libsystemd-dev valgrind

    - name: Build disk-watchdogd
      shell: bash
      run: |
        make clean
        make

    - name: Build disk-watchdogd with valgrind
      shell: bash
      run: |
        make valgrind

    - name: Test executable
      shell: bash
      run: |
        ./valgrind-disk-watchdogd --help
        ./disk-watchdogd --help

    - name: Run valgrind
      shell: bash
      run: |
        timeout --preserve-status 2s \
          valgrind --leak-check=full \
            --show-leak-kinds=all \
            --track-origins=yes \
            --verbose \
            --error-exitcode=1 \
            ./valgrind-disk-watchdogd -v -d -f ./valgrind-disk-watchdogd -i 100
